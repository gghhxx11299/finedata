<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ethiopia Agricultural Intelligence Dashboard - Real-time crop, weather, and soil analytics">
    <title>Ethiopia Agricultural Intelligence Dashboard</title>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-color: #0D1117;
            --primary-accent: #58A6FF;
            --secondary-accent: #FF7B72;
            --text-color: #C9D1D9;
            --card-bg: #161B22;
            --border-color: #30363d;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        header {
            background-color: var(--card-bg);
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            position: sticky;
            top: 0;
            z-index: 3000;
            border-bottom: 1px solid var(--primary-accent);
        }
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }
        .logo img {
            height: 40px;
            margin-right: 10px;
            border-radius: 4px;
        }
        .logo h1 {
            color: var(--primary-accent);
            font-size: 1.5rem;
            font-family: 'Montserrat', sans-serif;
        }
        .nav-links {
            display: flex;
            list-style: none;
        }
        .nav-links li {
            margin-left: 1rem;
        }
        .nav-links a {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
        }
        .nav-links a:hover, .nav-links a.active {
            color: var(--primary-accent);
        }
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--primary-accent);
            font-size: 1.5rem;
            cursor: pointer;
        }
        #app-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        #app {
            display: flex;
            flex: 1;
            position: relative;
        }
        #sidebar {
            width: 380px;
            background: var(--card-bg);
            overflow-y: auto;
            box-shadow: 3px 0 15px rgba(0,0,0,0.3);
            z-index: 100;
            display: flex;
            flex-direction: column;
            color: var(--text-color);
            border-right: 1px solid var(--primary-accent);
            transition: transform 0.3s ease;
        }
        #header {
            padding: 20px;
            background: linear-gradient(135deg, #0d47a1 0%, #1B5E20 100%);
            color: white;
            text-align: center;
        }
        #controls {
            padding: 18px;
            border-bottom: 1px solid var(--border-color);
        }
        .control-group {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .control-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .control-group h3 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: var(--primary-accent);
            font-family: 'Montserrat', sans-serif;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn {
            display: block;
            width: 100%;
            padding: 10px 12px;
            margin: 6px 0;
            background: var(--background-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95em;
        }
        .btn:hover {
            background: rgba(88, 166, 255, 0.1);
            border-left: 4px solid var(--primary-accent);
        }
        .btn.active, .btn.weather-active {
            background: rgba(88, 166, 255, 0.2);
            color: var(--primary-accent);
            border-left: 4px solid var(--primary-accent);
            font-weight: 700;
        }
        #data-panel {
            padding: 20px;
            flex: 1;
        }
        .region-info {
            background: var(--background-color);
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        .region-info h4 {
            color: var(--primary-accent);
            margin-bottom: 12px;
            font-size: 1.2em;
            font-family: 'Montserrat', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .stat-item {
            background: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .stat-label { font-size: 0.8em; color: #8B949E; }
        .stat-value { font-size: 1em; font-weight: 700; color: var(--primary-accent); }
        .stat-value.danger { color: var(--secondary-accent); }
        .stat-value.warning { color: #FFA500; }
        .stat-value.success { color: #3FB950; }
        #map-container {
            flex: 1;
            position: relative;
            height: 100%;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        #status {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(13, 17, 23, 0.9);
            color: var(--text-color);
            padding: 10px 14px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 280px;
            border: 1px solid var(--primary-accent);
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend, #timeline-controls {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: var(--card-bg);
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 260px;
            border: 1px solid var(--primary-accent);
            font-size: 0.9em;
        }
        #timeline-controls {
            bottom: 100px;
        }
        #menu-toggle {
            position: absolute;
            top: 15px;
            left: 15px;
            background: var(--card-bg);
            color: var(--primary-accent);
            border: 1px solid var(--primary-accent);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.1em;
            z-index: 1100;
            display: none;
            cursor: pointer;
        }
        .chart-container {
            height: 180px;
            margin-top: 12px;
        }
        footer {
            background-color: var(--card-bg);
            color: var(--text-color);
            padding: 2rem 0 1rem;
            margin-top: auto;
            border-top: 1px solid var(--primary-accent);
        }
        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .footer-section h3 {
            margin-bottom: 1rem;
            font-size: 1.1rem;
            color: var(--primary-accent);
            font-family: 'Montserrat', sans-serif;
        }
        .footer-section a {
            display: block;
            color: var(--text-color);
            text-decoration: none;
            margin-bottom: 0.4rem;
        }
        .footer-section a:hover {
            color: var(--primary-accent);
        }
        .footer-bottom {
            text-align: center;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.9em;
        }

        /* Mobile Responsive */
        @media (max-width: 992px) {
            #sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 300px;
                z-index: 2000;
                transform: translateX(-100%);
            }
            #sidebar.visible {
                transform: translateX(0);
            }
            #menu-toggle {
                display: block;
            }
            #app {
                flex-direction: column;
            }
            #map-container {
                height: calc(100vh - 120px);
            }
        }
        @media (max-width: 768px) {
            .nav-links {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background: var(--card-bg);
                flex-direction: column;
                padding: 1rem 0;
                border-top: 1px solid var(--primary-accent);
            }
            .nav-links.active { display: flex; }
            .nav-links li { margin: 0.5rem 1.5rem; }
            .mobile-menu-btn { display: block; }
            .stat-grid { grid-template-columns: 1fr; }
            .legend, #timeline-controls { max-width: 200px; font-size: 0.8em; }
            #timeline-controls { bottom: 70px; }
        }
        @media (max-width: 480px) {
            #sidebar { width: 100%; }
            .btn span { display: none; }
            .btn i { margin: 0 auto; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <div class="logo">
                    <img src="https://media.licdn.com/dms/image/v2/D4E22AQGXMc2SntbjBA/feedshare-shrink_800/B4EZk6G01vHoAk-/0/1757616497506?e=1760572800&v=beta&t=8j9qaS3FBcRpEqrjVREfn2y6DriWCK_IxbIG0HmwhRg" alt="Finedata Logo">
                    <h1>Finedatas</h1>
                </div>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="economic.html">Economic</a></li>
                    <li><a href="demographic.html">Demographic</a></li>
                    <li><a href="agricultural.html">Agricultural</a></li>
                    <li><a href="ai-chat.html">AI Chat</a></li>
                    <li><a href="news.html">News</a></li>
                    <li><a href="exchange.html">Exchange Rates</a></li>
                    <li><a href="pdf.html">PDF Resources</a></li>
                    <li><a href="weather.html">For Farmers</a></li>
                    <li><a href="globe.html" class="active">Weather Data</a></li>
                    <li><a href="insights.html">Get Forecasts</a></li>
                    <li><a href="support.html">Support</a></li>
                    <li><a href="donate.html">Donate</a></li>
                </ul>
                <button class="mobile-menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
            </nav>
        </div>
    </header>

    <div id="app-wrapper">
        <div id="app">
            <div id="sidebar">
                <div id="header">
                    <h1><i class="fas fa-seedling"></i> Ethiopia Agricultural Intelligence</h1>
                    <p>Real-time Crop, Weather & Soil Analytics</p>
                    <div id="last-updated">Last updated: <span id="update-time">Today</span></div>
                </div>
                <div id="controls">
                    <div class="control-group">
                        <h3><i class="fas fa-cloud"></i> Working Weather Layers</h3>
                        <button id="btnNone" class="btn weather-active">
                            <i class="fas fa-ban"></i> None
                        </button>
                        <button id="btnClouds" class="btn">
                            <i class="fas fa-cloud"></i> Cloud Cover (MODIS)
                        </button>
                        <button id="btnRain" class="btn">
                            <i class="fas fa-cloud-rain"></i> Rainfall (GPM)
                        </button>
                        <button id="btnTemp" class="btn">
                            <i class="fas fa-temperature-high"></i> Land Temperature
                        </button>
                        <button id="btnPrecip" class="btn">
                            <i class="fas fa-tint"></i> Precipitation Rate
                        </button>
                    </div>
                    <div class="control-group">
                        <h3><i class="fas fa-leaf"></i> Crop Focus</h3>
                        <button class="btn crop-btn active" data-crop="all">
                            <i class="fas fa-globe-africa"></i> All Crops
                        </button>
                        <button class="btn crop-btn" data-crop="teff">
                            <i class="fas fa-wheat-alt"></i> Teff
                        </button>
                        <button class="btn crop-btn" data-crop="maize">
                            <i class="fas fa-corn"></i> Maize
                        </button>
                        <button class="btn crop-btn" data-crop="wheat">
                            <i class="fas fa-wheat-awn"></i> Wheat
                        </button>
                        <button class="btn crop-btn" data-crop="sorghum">
                            <i class="fas fa-seedling"></i> Sorghum
                        </button>
                        <button class="btn crop-btn" data-crop="enset">
                            <i class="fas fa-tree"></i> Enset
                        </button>
                        <button class="btn crop-btn" data-crop="coffee">
                            <i class="fas fa-mug-hot"></i> Coffee
                        </button>
                        <button class="btn crop-btn" data-crop="sesame">
                            <i class="fas fa-seedling"></i> Sesame
                        </button>
                        <button class="btn crop-btn" data-crop="beans">
                            <i class="fas fa-pepper-hot"></i> Beans
                        </button>
                        <button class="btn crop-btn" data-crop="barley">
                            <i class="fas fa-beer"></i> Barley
                        </button>
                    </div>
                    <div class="control-group">
                        <h3><i class="fas fa-chart-line"></i> Analytics</h3>
                        <button id="btnExport" class="btn">
                            <i class="fas fa-file-csv"></i> Export Full Report (CSV)
                        </button>
                        <button id="btnReset" class="btn">
                            <i class="fas fa-redo"></i> Reset Dashboard
                        </button>
                    </div>
                </div>
                <div id="data-panel">
                    <div class="region-info">
                        <h4><i class="fas fa-chart-pie"></i> 🇪🇹 National Agricultural Summary</h4>
                        <div class="stat-grid">
                            <div class="stat-item">
                                <div class="stat-label">Total Arable Land</div>
                                <div class="stat-value">15.2M ha</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Avg. Crop Yield</div>
                                <div class="stat-value">2.8 tons/ha</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Main Crop</div>
                                <div class="stat-value">Teff</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Irrigation Coverage</div>
                                <div class="stat-value">5.2%</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Avg. Rainfall (Annual)</div>
                                <div class="stat-value">850 mm</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Drought Risk</div>
                                <div class="stat-value warning">Moderate</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Soil Fertility</div>
                                <div class="stat-value success">Good</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Food Security Index</div>
                                <div class="stat-value warning">68/100</div>
                            </div>
                        </div>
                    </div>
                    <div id="selected-region" class="region-info" style="display:none;">
                        <h4 id="region-name"><i class="fas fa-map-marker-alt"></i> Region Agricultural Profile</h4>
                        <div id="region-stats" class="stat-grid"></div>
                        <div id="yield-trend" class="region-info" style="display:none; margin-top: 15px;">
                            <h4><i class="fas fa-chart-line"></i> Yield Trend (2020-2024)</h4>
                            <div class="chart-container">
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>
                        <div id="price-trend" class="region-info" style="display:none; margin-top: 15px;">
                            <h4><i class="fas fa-chart-bar"></i> Market Price Trend</h4>
                            <div class="chart-container">
                                <canvas id="priceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="map-container">
                <div id="map"></div>
                <div id="status">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Loading Ethiopia Dashboard...</span>
                </div>
                <div class="legend">
                    <h4>Yield Classification (tons/ha)</h4>
                    <div style="display:flex; align-items:center; margin:4px 0;">
                        <div style="width:20px; height:12px; background:#1B5E20; margin-right:8px;"></div>
                        <span>Excellent (≥ 4.0)</span>
                    </div>
                    <div style="display:flex; align-items:center; margin:4px 0;">
                        <div style="width:20px; height:12px; background:#2E7D32; margin-right:8px;"></div>
                        <span>Good (3.0 – 3.9)</span>
                    </div>
                    <div style="display:flex; align-items:center; margin:4px 0;">
                        <div style="width:20px; height:12px; background:#4CAF50; margin-right:8px;"></div>
                        <span>Fair (2.0 – 2.9)</span>
                    </div>
                    <div style="display:flex; align-items:center; margin:4px 0;">
                        <div style="width:20px; height:12px; background:#81C784; margin-right:8px;"></div>
                        <span>Poor (< 2.0)</span>
                    </div>
                </div>
                <div id="timeline-controls">
                    <h4><i class="fas fa-calendar-alt"></i> Time Series</h4>
                    <input type="range" id="timeSlider" min="0" max="364" value="182" style="width:100%;">
                    <div id="dateDisplay">2024-06-30</div>
                </div>
                <button id="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>About Finedatas</h3>
                    <p>Ethiopia's premier data hub providing comprehensive economic, demographic, and agricultural statistics.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-linkedin-in"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <a href="economic.html">Economic Data</a>
                    <a href="demographic.html">Demographic Data</a>
                    <a href="agricultural.html">Agricultural Data</a>
                    <a href="exchange.html">Exchange Rates</a>
                    <a href="news.html">News</a>
                </div>
                <div class="footer-section">
                    <h3>Contact Us</h3>
                    <p><i class="fas fa-envelope"></i> gabrielmulugeta1@gmail.com</p>
                    <p><i class="fas fa-phone"></i> +251 991 168 917</p>
                    <p><i class="fas fa-phone"></i> +251 701 327 186</p>
                    <p><i class="fas fa-map-marker-alt"></i> Addis Ababa, Ethiopia</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Finedatas. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Mobile nav toggle
        const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
        const navLinks = document.querySelector('.nav-links');
        mobileMenuBtn.addEventListener('click', () => navLinks.classList.toggle('active'));
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.nav-links') && !e.target.closest('.mobile-menu-btn')) {
                navLinks.classList.remove('active');
            }
        });

        // Sidebar toggle
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        let map = null;

        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('visible');
            if (map) setTimeout(() => map.invalidateSize(), 300);
        });

        // ✅ Only close sidebar when tapping MAP (not buttons!)
        document.getElementById('map').addEventListener('click', (e) => {
            if (window.innerWidth <= 992 && sidebar.classList.contains('visible')) {
                if (!e.target.closest('.leaflet-control') && !e.target.closest('#status')) {
                    sidebar.classList.remove('visible');
                    if (map) map.invalidateSize();
                }
            }
        });

        // Prevent sidebar from closing when clicking inside it
        document.getElementById('sidebar').addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // ETHIOPIA DATA
        const ETHIOPIA_REGIONS = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "region": "Amhara",
                        "main_crop": "Teff",
                        "crop": "teff",
                        "yield": 2.1,
                        "area_ha": 1200000,
                        "soil_moisture_proxy": 0.65,
                        "crop_health_index": 0.72,
                        "drought_risk": "Moderate",
                        "irrigation_pct": 8.5,
                        "fertilizer_use": "Medium",
                        "pest_pressure": "Medium",
                        "market_price_index": 1.2,
                        "labor_availability": "High",
                        "storage_facilities": "Limited",
                        "extension_services": "Available",
                        "climate_resilience": "Medium",
                        "biodiversity_score": 0.68,
                        "yield_history": [1.9, 2.0, 2.1, 2.2, 2.1],
                        "price_history": [2200, 2300, 2400, 2500, 2600]
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [37.0, 13.8], [39.9, 13.8], [39.9, 13.2], [40.2, 12.8], 
                            [40.1, 12.2], [39.8, 11.8], [39.5, 11.2], [39.2, 10.8],
                            [38.8, 10.5], [38.2, 10.2], [37.5, 10.0], [37.0, 10.2],
                            [36.8, 10.5], [36.7, 11.0], [36.8, 11.8], [37.0, 12.5],
                            [37.0, 13.8]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "region": "Oromia - Maize Belt",
                        "main_crop": "Maize",
                        "crop": "maize",
                        "yield": 3.8,
                        "area_ha": 1500000,
                        "soil_moisture_proxy": 0.78,
                        "crop_health_index": 0.85,
                        "drought_risk": "Low",
                        "irrigation_pct": 6.2,
                        "fertilizer_use": "High",
                        "pest_pressure": "High",
                        "market_price_index": 1.0,
                        "labor_availability": "Very High",
                        "storage_facilities": "Good",
                        "extension_services": "Extensive",
                        "climate_resilience": "High",
                        "biodiversity_score": 0.82,
                        "yield_history": [3.5, 3.6, 3.7, 3.8, 3.8],
                        "price_history": [1800, 1850, 1900, 1950, 2000]
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [36.6, 9.6], [39.0, 9.6], [39.0, 9.0], [39.2, 8.5], 
                            [39.1, 8.0], [38.8, 7.5], [38.5, 7.2], [38.0, 7.0],
                            [37.5, 6.8], [37.0, 6.7], [36.5, 6.8], [36.2, 7.0],
                            [36.0, 7.5], [36.1, 8.0], [36.3, 8.5], [36.6, 9.0],
                            [36.6, 9.6]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "region": "Oromia - Coffee Zone",
                        "main_crop": "Coffee",
                        "crop": "coffee",
                        "yield": 0.6,
                        "area_ha": 420000,
                        "soil_moisture_proxy": 0.82,
                        "crop_health_index": 0.75,
                        "drought_risk": "Low",
                        "irrigation_pct": 1.5,
                        "fertilizer_use": "Medium",
                        "pest_pressure": "Medium",
                        "market_price_index": 1.5,
                        "labor_availability": "High",
                        "storage_facilities": "Good",
                        "extension_services": "Available",
                        "climate_resilience": "Medium",
                        "biodiversity_score": 0.88,
                        "yield_history": [0.55, 0.58, 0.60, 0.62, 0.60],
                        "price_history": [85000, 90000, 95000, 100000, 105000]
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [34.8, 7.8], [37.0, 7.8], [37.0, 7.2], [36.8, 6.8],
                            [36.5, 6.5], [36.0, 6.3], [35.5, 6.2], [35.0, 6.3],
                            [34.7, 6.5], [34.5, 6.8], [34.6, 7.2], [34.8, 7.8]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "region": "Tigray",
                        "main_crop": "Wheat",
                        "crop": "wheat",
                        "yield": 1.9,
                        "area_ha": 850000,
                        "soil_moisture_proxy": 0.42,
                        "crop_health_index": 0.58,
                        "drought_risk": "High",
                        "irrigation_pct": 18.0,
                        "fertilizer_use": "Medium",
                        "pest_pressure": "Low",
                        "market_price_index": 1.3,
                        "labor_availability": "Medium",
                        "storage_facilities": "Poor",
                        "extension_services": "Limited",
                        "climate_resilience": "Low",
                        "biodiversity_score": 0.45,
                        "yield_history": [1.7, 1.8, 1.8, 1.9, 1.9],
                        "price_history": [2400, 2500, 2600, 2700, 2800]
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [37.6, 14.8], [39.8, 14.8], [39.8, 14.0], [39.6, 13.5],
                            [39.3, 13.0], [39.0, 12.7], [38.5, 12.5], [38.0, 12.6],
                            [37.7, 12.8], [37.5, 13.2], [37.4, 13.8], [37.6, 14.8]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "region": "Afar",
                        "main_crop": "Sorghum",
                        "crop": "sorghum",
                        "yield": 0.9,
                        "area_ha": 180000,
                        "soil_moisture_proxy": 0.25,
                        "crop_health_index": 0.45,
                        "drought_risk": "Very High",
                        "irrigation_pct": 12.0,
                        "fertilizer_use": "Very Low",
                        "pest_pressure": "Low",
                        "market_price_index": 0.8,
                        "labor_availability": "Low",
                        "storage_facilities": "Very Poor",
                        "extension_services": "Very Limited",
                        "climate_resilience": "Very Low",
                        "biodiversity_score": 0.30,
                        "yield_history": [0.8, 0.85, 0.9, 0.85, 0.9],
                        "price_history": [1600, 1650, 1700, 1750, 1800]
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [39.5, 14.2], [41.0, 14.2], [41.0, 12.0], [40.8, 10.0],
                            [40.5, 8.5], [40.0, 8.0], [39.5, 8.2], [39.2, 8.5],
                            [39.0, 9.0], [39.1, 10.0], [39.3, 12.0], [39.5, 14.2]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "region": "Sidama",
                        "main_crop": "Enset",
                        "crop": "enset",
                        "yield": 4.2,
                        "area_ha": 180000,
                        "soil_moisture_proxy": 0.75,
                        "crop_health_index": 0.88,
                        "drought_risk": "Low",
                        "irrigation_pct": 3.0,
                        "fertilizer_use": "Low",
                        "pest_pressure": "Low",
                        "market_price_index": 1.1,
                        "labor_availability": "High",
                        "storage_facilities": "Good",
                        "extension_services": "Available",
                        "climate_resilience": "High",
                        "biodiversity_score": 0.85,
                        "yield_history": [4.0, 4.1, 4.2, 4.3, 4.2],
                        "price_history": [1200, 1250, 1300, 1350, 1400]
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [37.8, 6.9], [38.8, 6.9], [38.8, 6.5], [38.6, 6.2],
                            [38.3, 6.0], [38.0, 6.1], [37.8, 6.3], [37.7, 6.6],
                            [37.8, 6.9]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "region": "Benishangul-Gumuz",
                        "main_crop": "Sesame",
                        "crop": "sesame",
                        "yield": 0.8,
                        "area_ha": 210000,
                        "soil_moisture_proxy": 0.68,
                        "crop_health_index": 0.70,
                        "drought_risk": "Moderate",
                        "irrigation_pct": 5.0,
                        "fertilizer_use": "Low",
                        "pest_pressure": "Medium",
                        "market_price_index": 1.4,
                        "labor_availability": "Medium",
                        "storage_facilities": "Limited",
                        "extension_services": "Limited",
                        "climate_resilience": "Medium",
                        "biodiversity_score": 0.70,
                        "yield_history": [0.75, 0.78, 0.80, 0.82, 0.80],
                        "price_history": [35000, 36000, 37000, 38000, 39000]
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [34.5, 11.8], [36.5, 11.8], [36.5, 11.0], [36.3, 10.5],
                            [36.0, 10.0], [35.5, 9.7], [35.0, 9.5], [34.7, 9.6],
                            [34.5, 10.0], [34.4, 10.5], [34.5, 11.0], [34.5, 11.8]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "region": "SNNPR",
                        "main_crop": "Beans",
                        "crop": "beans",
                        "yield": 1.2,
                        "area_ha": 320000,
                        "soil_moisture_proxy": 0.72,
                        "crop_health_index": 0.78,
                        "drought_risk": "Low",
                        "irrigation_pct": 4.0,
                        "fertilizer_use": "Medium",
                        "pest_pressure": "Medium",
                        "market_price_index": 1.2,
                        "labor_availability": "High",
                        "storage_facilities": "Good",
                        "extension_services": "Available",
                        "climate_resilience": "Medium",
                        "biodiversity_score": 0.75,
                        "yield_history": [1.1, 1.15, 1.2, 1.25, 1.2],
                        "price_history": [2800, 2900, 3000, 3100, 3200]
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [35.8, 7.8], [38.5, 7.8], [38.5, 7.0], [38.2, 6.5],
                            [37.8, 6.0], [37.2, 5.7], [36.5, 5.5], [36.0, 5.6],
                            [35.7, 5.8], [35.6, 6.2], [35.7, 6.8], [35.8, 7.8]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "region": "Amhara Highlands",
                        "main_crop": "Barley",
                        "crop": "barley",
                        "yield": 1.8,
                        "area_ha": 280000,
                        "soil_moisture_proxy": 0.58,
                        "crop_health_index": 0.65,
                        "drought_risk": "Moderate",
                        "irrigation_pct": 10.0,
                        "fertilizer_use": "Medium",
                        "pest_pressure": "Low",
                        "market_price_index": 1.1,
                        "labor_availability": "Medium",
                        "storage_facilities": "Limited",
                        "extension_services": "Available",
                        "climate_resilience": "Medium",
                        "biodiversity_score": 0.60,
                        "yield_history": [1.6, 1.7, 1.75, 1.8, 1.8],
                        "price_history": [2000, 2100, 2200, 2300, 2400]
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [37.5, 13.2], [39.2, 13.2], [39.2, 12.8], [39.0, 12.5],
                            [38.7, 12.2], [38.3, 12.0], [37.8, 11.9], [37.5, 12.0],
                            [37.3, 12.2], [37.2, 12.5], [37.3, 12.8], [37.5, 13.2]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "region": "Gambela",
                        "main_crop": "Maize",
                        "crop": "maize",
                        "yield": 2.8,
                        "area_ha": 95000,
                        "soil_moisture_proxy": 0.85,
                        "crop_health_index": 0.82,
                        "drought_risk": "Low",
                        "irrigation_pct": 2.0,
                        "fertilizer_use": "Medium",
                        "pest_pressure": "High",
                        "market_price_index": 0.9,
                        "labor_availability": "Medium",
                        "storage_facilities": "Limited",
                        "extension_services": "Limited",
                        "climate_resilience": "Medium",
                        "biodiversity_score": 0.80,
                        "yield_history": [2.6, 2.7, 2.75, 2.8, 2.8],
                        "price_history": [1700, 1750, 1800, 1850, 1900]
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [33.8, 8.5], [35.0, 8.5], [35.0, 8.0], [34.8, 7.7],
                            [34.5, 7.5], [34.2, 7.4], [34.0, 7.5], [33.9, 7.7],
                            [33.8, 8.0], [33.8, 8.5]
                        ]]
                    }
                }
            ]
        };

        // GLOBAL STATE
        let ethiopiaLayer = null;
        let weatherLayers = {};
        let currentWeather = 'none';
        let currentCropFilter = 'all';
        let trendChart = null;
        let priceChart = null;
        const today = new Date();
        const baseDate = new Date(today.getFullYear(), 0, 1);

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('update-time').textContent = new Date().toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric'
            });

            map = L.map('map', { zoomControl: false }).setView([9.145, 40.489], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            updateEthiopiaLayer();
            setupEventListeners();
            document.getElementById('status').innerHTML = '<i class="fas fa-check-circle"></i> <span>Dashboard Ready! Tap a region.</span>';

            setTimeout(() => { if (map) map.invalidateSize(); }, 500);
        });

        function updateEthiopiaLayer() {
            if (ethiopiaLayer) map.removeLayer(ethiopiaLayer);
            ethiopiaLayer = L.geoJSON(ETHIOPIA_REGIONS, {
                style: getRegionStyle,
                onEachFeature: function(feature, layer) {
                    const props = feature.properties;
                    const popupContent = `
                        <div style="min-width:250px;">
                            <h3 style="color:#58A6FF;margin-bottom:10px;">${props.region}</h3>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.9em;">
                                <div><b>Main Crop:</b> ${props.main_crop}</div>
                                <div><b>Yield:</b> ${props.yield} tons/ha</div>
                                <div><b>Rainfall:</b> ${getRainfallForRegion(props.region)} mm</div>
                                <div><b>Temp:</b> ${getTemperatureForRegion(props.region)}°C</div>
                                <div><b>Drought Risk:</b> ${props.drought_risk}</div>
                                <div><b>Food Security:</b> ${getFoodSecurityForRegion(props.region)}/100</div>
                                <div><b>Irrigation:</b> ${props.irrigation_pct}%</div>
                            </div>
                        </div>
                    `;
                    layer.bindPopup(popupContent);
                    layer.on('click', () => showRegionDetails(props));
                }
            }).addTo(map);
        }

        function getRegionStyle(feature) {
            const { crop, yield } = feature.properties;
            if (currentCropFilter !== 'all' && crop !== currentCropFilter) {
                return { fillOpacity: 0, stroke: false, interactive: false };
            }
            let color = yield >= 4 ? '#1B5E20' : yield >= 3 ? '#2E7D32' : yield >= 2 ? '#4CAF50' : '#81C784';
            return { fillColor: color, weight: 2, opacity: 1, color: 'white', fillOpacity: 0.75 };
        }

        function setWeatherLayer(layerType) {
            Object.values(weatherLayers).forEach(l => { if (l) map.removeLayer(l); });
            weatherLayers = {};
            if (layerType === 'none') return (currentWeather = 'none');
            currentWeather = layerType;
            let wmsLayer;
            const time = new Date(baseDate); time.setDate(time.getDate() + parseInt(document.getElementById('timeSlider').value));
            const dateStr = time.toISOString().split('T')[0];
            switch(layerType) {
                case 'clouds':
                    wmsLayer = L.tileLayer.wms("https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi", {
                        layers: 'MODIS_Terra_CorrectedReflectance_TrueColor',
                        format: 'image/jpeg', transparent: false, opacity: 0.85, time: dateStr, attribution: "NASA GIBS"
                    }); break;
                case 'rain':
                    wmsLayer = L.tileLayer.wms("https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi", {
                        layers: 'GPM_3IMERGDF_06_Daily', format: 'image/png', transparent: true, opacity: 0.8, time: dateStr, attribution: "NASA GIBS"
                    }); break;
                case 'temp':
                    wmsLayer = L.tileLayer.wms("https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi", {
                        layers: 'MODIS_Terra_Land_Surface_Temp_Day', format: 'image/png', transparent: true, opacity: 0.75, time: dateStr, attribution: "NASA GIBS"
                    }); break;
                case 'precip':
                    wmsLayer = L.tileLayer.wms("https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi", {
                        layers: 'GPM_3IMERGDE_06_Hourly', format: 'image/png', transparent: true, opacity: 0.8, time: dateStr, attribution: "NASA GIBS"
                    }); break;
            }
            if (wmsLayer) {
                wmsLayer.addTo(map);
                weatherLayers[layerType] = wmsLayer;
                document.getElementById('status').innerHTML = `<i class="fas fa-check-circle"></i> <span>${layerType.charAt(0).toUpperCase() + layerType.slice(1)} layer active!</span>`;
                if (map) setTimeout(() => map.invalidateSize(), 300);
            } else {
                document.getElementById('status').innerHTML = `<i class="fas fa-exclamation-triangle"></i> <span>${layerType} layer failed</span>`;
            }
        }

        function getSelectedDate() {
            const days = parseInt(document.getElementById('timeSlider').value);
            const date = new Date(baseDate); date.setDate(date.getDate() + days);
            return date.toISOString().split('T')[0];
        }

        function updateDateDisplay() {
            const days = parseInt(document.getElementById('timeSlider').value);
            const date = new Date(baseDate); date.setDate(date.getDate() + days);
            document.getElementById('dateDisplay').textContent = date.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        function showRegionDetails(props) {
            document.getElementById('selected-region').style.display = 'block';
            document.getElementById('region-name').textContent = `${props.region} Agricultural Profile`;
            const droughtClass = props.drought_risk === "Very High" || props.drought_risk === "High" ? 'danger' : props.drought_risk === "Moderate" ? 'warning' : 'success';
            const healthClass = props.crop_health_index < 0.6 ? 'danger' : props.crop_health_index < 0.8 ? 'warning' : 'success';
            const moistureClass = props.soil_moisture_proxy < 0.5 ? 'danger' : props.soil_moisture_proxy < 0.7 ? 'warning' : 'success';
            document.getElementById('region-stats').innerHTML = `
                <div class="stat-item"><div class="stat-label">Region Type</div><div class="stat-value">${props.region.includes('Highlands') ? 'Highlands' : props.region.includes('Belt') ? 'Lowlands' : 'Mixed'}</div></div>
                <div class="stat-item"><div class="stat-label">Main Crop</div><div class="stat-value">${props.main_crop}</div></div>
                <div class="stat-item"><div class="stat-label">Crop Yield</div><div class="stat-value ${healthClass}">${props.yield} tons/ha</div></div>
                <div class="stat-item"><div class="stat-label">Cultivated Area</div><div class="stat-value">${props.area_ha.toLocaleString()} ha</div></div>
                <div class="stat-item"><div class="stat-label">Soil Moisture Proxy</div><div class="stat-value ${moistureClass}">${(props.soil_moisture_proxy * 100).toFixed(1)}%</div></div>
                <div class="stat-item"><div class="stat-label">Crop Health Index</div><div class="stat-value ${healthClass}">${(props.crop_health_index * 100).toFixed(1)}%</div></div>
                <div class="stat-item"><div class="stat-label">Drought Risk</div><div class="stat-value ${droughtClass}">${props.drought_risk}</div></div>
                <div class="stat-item"><div class="stat-label">Irrigation Coverage</div><div class="stat-value">${props.irrigation_pct}%</div></div>
                <div class="stat-item"><div class="stat-label">Fertilizer Use</div><div class="stat-value">${props.fertilizer_use}</div></div>
                <div class="stat-item"><div class="stat-label">Pest Pressure</div><div class="stat-value">${props.pest_pressure}</div></div>
                <div class="stat-item"><div class="stat-label">Market Price Index</div><div class="stat-value">${props.market_price_index}</div></div>
                <div class="stat-item"><div class="stat-label">Labor Availability</div><div class="stat-value">${props.labor_availability}</div></div>
                <div class="stat-item"><div class="stat-label">Storage Facilities</div><div class="stat-value">${props.storage_facilities}</div></div>
                <div class="stat-item"><div class="stat-label">Extension Services</div><div class="stat-value">${props.extension_services}</div></div>
                <div class="stat-item"><div class="stat-label">Climate Resilience</div><div class="stat-value">${props.climate_resilience}</div></div>
                <div class="stat-item"><div class="stat-label">Biodiversity Score</div><div class="stat-value">${(props.biodiversity_score * 100).toFixed(1)}%</div></div>
            `;
            document.getElementById('yield-trend').style.display = 'block';
            document.getElementById('price-trend').style.display = 'block';
            if (trendChart) trendChart.destroy();
            trendChart = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                 {
                    labels: ['2020','2021','2022','2023','2024'],
                    datasets: [{ label: `${props.main_crop} Yield (tons/ha)`,  props.yield_history, borderColor: '#4CAF50', backgroundColor: 'rgba(76,175,80,0.1)', borderWidth: 3, tension: 0.3, fill: true }]
                },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } }, responsive: true, maintainAspectRatio: false }
            });
            if (priceChart) priceChart.destroy();
            priceChart = new Chart(document.getElementById('priceChart'), {
                type: 'bar',
                 {
                    labels: ['2020','2021','2022','2023','2024'],
                    datasets: [{ label: `${props.main_crop} Price`,  props.price_history, backgroundColor: '#2196F3' }]
                },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } }, responsive: true, maintainAspectRatio: false }
            });
        }

        function setupEventListeners() {
            ['None','Clouds','Rain','Temp','Precip'].forEach(name => {
                const id = `btn${name}`;
                const type = name === 'None' ? 'none' : name.toLowerCase();
                document.getElementById(id).addEventListener('click', () => {
                    setWeatherLayer(type);
                    document.querySelectorAll('.btn').forEach(b => b.classList.remove('weather-active'));
                    document.getElementById(id).classList.add('weather-active');
                    if (window.innerWidth <= 992) {
                        sidebar.classList.add('visible');
                    }
                });
            });
            document.querySelectorAll('.crop-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const crop = btn.getAttribute('data-crop');
                    setCropFilter(crop);
                    document.querySelectorAll('.crop-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    if (window.innerWidth <= 992) {
                        sidebar.classList.add('visible');
                    }
                });
            });
            document.getElementById('btnExport').addEventListener('click', exportData);
            document.getElementById('btnReset').addEventListener('click', resetDashboard);
            document.getElementById('timeSlider').addEventListener('input', () => {
                updateDateDisplay();
                if (currentWeather !== 'none') setWeatherLayer(currentWeather);
            });
            updateDateDisplay();
        }

        function setCropFilter(cropType) {
            currentCropFilter = cropType;
            updateEthiopiaLayer();
            document.getElementById('status').innerHTML = `<i class="fas fa-filter"></i> <span>Filtered: ${cropType === 'all' ? 'All Crops' : cropType.charAt(0).toUpperCase() + cropType.slice(1)}</span>`;
        }

        function getRainfallForRegion(region) {
            const map = { 'Amhara':1200, 'Oromia - Maize Belt':1100, 'Oromia - Coffee Zone':1800, 'Tigray':600, 'Afar':200, 'Sidama':1300, 'Benishangul-Gumuz':1000, 'SNNPR':1500, 'Amhara Highlands':1150, 'Gambela':1500 };
            return map[region] || 850;
        }
        function getTemperatureForRegion(region) {
            const map = { 'Amhara':19.8, 'Oromia - Maize Belt':21.5, 'Oromia - Coffee Zone':23.4, 'Tigray':22.7, 'Afar':31.2, 'Sidama':20.1, 'Benishangul-Gumuz':25.4, 'SNNPR':22.0, 'Amhara Highlands':18.5, 'Gambela':27.6 };
            return map[region] || 22.0;
        }
        function getFoodSecurityForRegion(region) {
            const map = { 'Amhara':65, 'Oromia - Maize Belt':72, 'Oromia - Coffee Zone':70, 'Tigray':58, 'Afar':42, 'Sidama':78, 'Benishangul-Gumuz':68, 'SNNPR':75, 'Amhara Highlands':67, 'Gambela':70 };
            return map[region] || 68;
        }

        function exportData() {
            const headers = ['Region','Main Crop','Crop','Yield (tons/ha)','Area (ha)','Soil Moisture Proxy','Crop Health Index','Drought Risk','Irrigation (%)','Fertilizer Use','Pest Pressure','Market Price Index','Labor Availability','Storage Facilities','Extension Services','Climate Resilience','Biodiversity Score'];
            const rows = ETHIOPIA_REGIONS.features.map(f => {
                const p = f.properties;
                return [p.region, p.main_crop, p.crop, p.yield, p.area_ha, p.soil_moisture_proxy, p.crop_health_index, p.drought_risk, p.irrigation_pct, p.fertilizer_use, p.pest_pressure, p.market_price_index, p.labor_availability, p.storage_facilities, p.extension_services, p.climate_resilience, p.biodiversity_score];
            });
            const csv = [headers, ...rows].map(r => r.map(f => `"${f}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ethiopia_agricultural_data_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            document.getElementById('status').innerHTML = '<i class="fas fa-file-csv"></i> <span>Exported successfully!</span>';
            setTimeout(() => {
                document.getElementById('status').innerHTML = '<i class="fas fa-check-circle"></i> <span>Ready! Tap a region.</span>';
            }, 3000);
        }

        function resetDashboard() {
            currentCropFilter = 'all';
            currentWeather = 'none';
            document.querySelectorAll('.crop-btn').forEach(btn => btn.classList.toggle('active', btn.getAttribute('data-crop') === 'all'));
            document.querySelectorAll('.btn').forEach(btn => {
                if (btn.id === 'btnNone') btn.classList.add('weather-active');
                else if (['Clouds','Rain','Temp','Precip'].some(s => btn.id.includes(s))) btn.classList.remove('weather-active');
            });
            updateEthiopiaLayer();
            setWeatherLayer('none');
            document.getElementById('selected-region').style.display = 'none';
            document.getElementById('status').innerHTML = '<i class="fas fa-sync-alt"></i> <span>Reset complete.</span>';
            setTimeout(() => {
                document.getElementById('status').innerHTML = '<i class="fas fa-check-circle"></i> <span>Ready! Tap a region.</span>';
            }, 2000);
        }

        window.addEventListener('resize', () => { if (map) map.invalidateSize(); });
    </script>
</body>
</html>
